#include "api.h"
#include "parameters.h"
#include "shake_prng.h"
#include "vector.h"

#include <stdlib.h>  // For malloc, free
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <esp_heap_caps.h>  // For heap_caps_malloc and heap_caps_free
#include <time.h>

struct timespec start,end;

//Global deffinition so i can easily change up here
const char *sk_static = "E7DDE140798F25F18A47C033F9CCD584EEA95AA61E2698D54D49806F304715BD57D05362054E288BD46F8E7F2DA497FFC44746A4A0E5FE90762E19D60CDA5B8C9C05191BF7A630AD64FC8FD0B75A9330E9422B0D78212E8BC28994458DA698B92571C4C644336873D7AEA9F6E63BA5E8755CCCE7DD2B66CC4C0AB6B5F0166E7FA5DBC9FE03E270367FCAFF92C618FA9E0303FBD8279D38454974B29CABA4FFE2DD286E77B97A1A38D488664561EC66C67B608A0B6DFB0B9AA22D1837674269B11798A49B556A09B31D3F98CE6220A36A992B58B71B3E79208052192A3DD596B305360AA5F599A449A8F6C77EFD1538C390784A938B975BBF9B03A782E974A51E53E6B64BE24B17C88AE928F47C74BCB7FF325EBE62C0696DF9DDB1D0C0C2AB6905820156345E7BF9BD76202E875AEE68BD2663A851F814DE24A6DB48605F44E76C97D861647850ABB180639FF5885B3BF365B1A47975CDFED127BC01A7F167F883EDE25F089C39049F958CA4621517B3385065F1D8319B5AADED9DACA8E7D69CE8C1315BCCB39DCC21081D7B2A40C2FAC79B71AC5604B45F1DA118CF2E0623A444357037AFF29CE065ED9406DB4B79F259BFEBE0AAC1268A47FF9B54EC2CA8EF006B74ADF11D291501659EBBF244912A548EF603B4501BB5BDCB4FFE887E1FFF9BA9E6A264A0BE89AF9D14A5BB6888A06562B5E9C4271E4D8F8930D35B4715A846FB689DB7C229E6932018CB0A26EA4CE03DDDB6FAC5A0A7EAA404C93613F9B41B247F7F613318CE05019A8244EB86B26887910AC552D6DB53BD7F436F0E0E4F1C6A4351807A0CB91142D01A120478641960082DEFC9C3232AB30B0C0EE8F71F2EBD52B316873DF2BE9378626C4B683746AC60CF9F467A538BF7DA9B974E88199E83099D6741128C8A6285B3EA5E2AC96C7BD5ED1056B6878D359B688E239E6DB00734924A8B974987FE7AB8432697B2AA759542A72E3AEE2AFB1145613A3B21B7ADB2EE022D09AF4698EA5700544A46CE8A60C8494BC28FD2ABDD08B1593F5EA9DDC02026A003CE0EEB01855157036269241E416164D8454ED6BCFE463EDD04D4835AD5FE77854936839A5C97E09D426A7E737DBB87D99B06AF841A102E8B40CCCB42400BF119DF108DD1B7236711AC2918B67A30674519C89A5FA125978708A669502AF9C8CB2BF168D98D6DD8E5614D8389753CE011F7F9A061B251B87AFA4E28478F9FBD352619B17D6E5DEB047B618DDFCDE59C2E3C071381AFF0DD9EEB8B8EB387CFA5DDCEF0DC3C6702740F258F3008FAEDB3A6802E45878B621754F4AAE333836F6BB40AB1EE25F481B47F0046BC5A15C425EE189CFB3D059A40173936A3E16A8C1FDFEB9C08ADA1B1971015554CECEEC5504B61B495F5541625C21504AD862233AADD7E13B30D2C0FE7363DA93E4138233B1ADFAFF5B284FB032141FA29474D17403AB87B2E3ED4E66E96FBBD5643ECB013E37F60D98D96E662E516AAEB6AC794476EDDA4F00AF32D2B79EE7ABB77D10F33E0A147520DAB2042E6EBAEBA5F5F91A57D9453864D363318ADE486BE8CBB88BAD9953CE0F0B133E962BDAF93EB42FF435CD5B854ECE0380981C0F6A5A263D97AA60DBF1DE09B15F47C3869F40FCD8775E3D265F14B0DD538F0C3A185A242AEE82A357E9555ADEA21ABFC88795BC434100950D0757B58C8C751AC75A5017F5D7EFACDBAE8BE88DDF4D5F378BC64F55B68D1DB8B95B220EE788C91C9408DC42540245824A0B6874903D8D51DF867D6C0AAA92079749E68FF5D37D384139501A83D6E081C1244FCF7AD03A3998D80E94B068AD91DB39AD92C286BB05197EEF7B4D9822858540D5FA7A91640662EA65817269AEEB1DCC2284AEA9C4774193CAA7D4F84B5BBDA40B6D05FF10F9F1C3232B885282A4E27C6CFCA0D39944132A99FABD7E61D7A9605CDE6A257D5C709E923ACB893AC6D60E20FB5F2AC3C0844D66111AB9355F43049C29DE88D8B36DDE301448267CE865DA52777C5BD577D112AB5D7AB3B1B2CC76E8D74644C9FBAFEACB3D2455B05B92A16B1C66144F44158796AA7F38540B837ADEB1B4860C6FEA2C3132E96B6155367D412161CB1DA2425F11E9EE6E28776DD6940456BEF4AC8F77389867A97098F136AA216E7DEA3299A501A5BECA3F0358838F964C597A40158838276F8AB9DABC2EDC76BAEF4EE1B614CA92495E583C945301D7A33D4978FEFDD9F56ED219A8F34B0C35DBC09EFDC2C963A2F69FCBB4A132DDE857DB188305F0F20F062CA8507496E50F9AE4730534D0A7A58FB714D1FD65EA9C61752AE8B738BBA809D94B0D6E18B9F3CDF58C500B61C2CEB06D4DB43F5C516952CE251D775A38676A220C0B50FC7041091D56576CCCE8A5CD28D7BB819C2881DE584CDF6D2D8298EC9E6D42D68C954CC02F2C99A0D4782420F67B12E1C98FC1E4892EF442F98C54FB72460F03BD25FC803E186AE6272C95403A1FF269FE832D6681E9A8AE539A379D7954CECD70F56062B13B902B23F854432B92699D5B4C1D02920EA082AE3B0011A48F24EA9B54CEA0B1C5FC5210CC5B319146DD93BBAC2628FB830B9F317379672BE988EC5BAEB5E438AE71BDDB95D4F4F07EC5A63AB42EDBE2A674EC725D37FC2D7ECB3D94D8ECC5C8AAAA192EEBD250D051B06E58E4D5A53534F35BE74BBFFCB6E48122E89C9D11F6DD77AB7794FC050941191238E6C16C476E310E244E0B43F66B8DEFDAFA9B14703F6FB99D579C58D33F6E72645BA23997E1B9C52B739D544DDE894728CAFA015BE6625C6ABEBBB06B55666F7CF96F6CC66CD1E88A849B2985D641B088611F763925CDB5F616ADB39A9F816FF354A09894F1EB19D02F1068FB6571A97D90B9DE93176F767E4FC1B565484881A6795CC9FB59E09432B523EBA81D015AC4E6B805B8335CE3204D879B91FA0AB081D39E27E23F2936B75BAA4A15A8D13D6048D3E6A408F4E25F12D27F034903BDA4C2B3E01F0FB030D41338C0002799FA32FBDF34AD87DC1202F38746970D0155CD712462C232C9638D5A59C2AAD960EB62C7B2C2444DB0C3484BDDCEEDAC409D0E1B2C3A3A0B645EB2A296D1A9BD699DCE85E1F390832CA19B1D384C772214AE534DDE8E20F481A070CFADC1FE9DC90F6C8136E74C0311AC9654996D87D9A7DE39EEF35E3652FE7612B962D55C3756D892A99F688E0DF7172D5EB3E22D0B47C75696358FF922B6E6D88DE26C9047A2C73C11094A3999C03";
const char *cipher_text_string = "A444CADA31B7506A872B507D288ED7A3289ABC24FFFEF2F65600C099DBA926172A1BF0A1A7B50B6ABA8BB4CBB986D73CB7E176DA87A7E1025A3F89D92914D713A1E9451D9F2996218A3BD471A68280826B451446FED60A9A97A09AA3F2B08DFF98614A2F9B81B2AFA5F26A41A2A8DD1983F59096B071E2F28B0E11FA9EB7319B77E069DA621C8CDC1A855F42CC932322B1884F8155B92CF9B5B33CAAE8AB5F7A1EE25615E37E96436A09149CDA4EFABDB397B6B516AA6DB0A5448713A6296BE37DA36F59B16A48449651A3BC6B39926DEFE1FB5DC8D277229B80D5BF628185A97C4839D09790401FB6CE3F03DBAEFDEDF707AEBB3D2793F45ECDEAA212D80387702622CC37ED5E1618913A0A9009DDB2EBB296FD3C80B03FE0EF121197D876E50607B4449BAF9401376603A2E1BC9D45E2A86CE63121C51C6F84746483719282F470C014E5CC3EEF45D5DF0D32163991E050AC5F5F468DC0730A610AC0CD5DE830B236501E27D88A1B69B6D19D343D15F38F494B6240F7FA0D164C2C439B1D481A220529DE8AC76F1FE0ED9E79CC38B021D1AE44A1FC0EAC72B80B3A4A552FEC9C2E90D060A809B1F22CDD24CB65EE946FB7252AF874980E0B406456F163619432DF550F9E0EF20CF0B2EEF641C022D57AFB3D5B82035968EAA1DB08CDE8AB4B2A19FEC913F03ECB51540BAD54A5C8CBBF55920FD63113B730476F268612295ECD697ECFBCD90FF039665AA6372A31FB2451EAF3BA88A9703638262FCCE7FDB2AA84F4A333B6E49517715EAB78693035EBD975B47930C55FEA364ABB7F47F6A7A39F3D726A41BAFDD1A29318AF9ADD7ADB2D786CEEC521FB08774CF6C21738A3F0CD32F5F9E8CD107CD961C7FEFB1CE31F18B2B23621FB23D41EDA60A5B262D217F38E3C4088E7F57DF16C626D110F6974E37AD541C111407F9F6207AD960057F34545F5FABDE82AC3F3DB672F896282ABE368D178068A60B164ABE8B7734B7AB173C176B48614C769C79E3E0609E13811E122DFEB44049B0F9C81F98169ECED4885060AD9D85E5C84C519B0F953FA0426711362F3C7B66900BD40DEA4DA60B8F4D4E149F1DD230D95AE86C49B5E23B9F7EA978CA2FBE7F899F0E97CDDD0C7B9FA5DA19253B0A2F062783BA42D5707228447ADAFD3DBD8B30C699067081EB6B4C5A1E3D90CE92E52B71788D2A2C95951E4B003F3B9C4D39440400897A2BA184D6FB00B3B34709B237481AE3B3F8F14D192DE028655B0C9224C69E0789B05A6952AC07A7F2E7E55FB8CD7E93D00B788C439F4A20CC5AFA8BD38909388C9955F51CB302FC0363F6F8F419FB8BF7BDABAAB31F7BB27C22A6FA7774714336164406EA81495553C0104BE9EC978533D0E9C5B1C1A939CFD8E0BAE84F70052DA20052D8573C85C3BBB1FFF3116B1DAB7D6D7595546070BBFE7650B56255D8E3410671500AE854A3BDDF743D15A95088703C2A5999852A75448C8357FF2577F1B12B26C3CB8DA945287A093FDDF7DBE13C4C3BF15B80FAFFD79CB8407CB34FC37D453736560C3EA3353BC54B81EFF6C92202163C26B7418C29128769AB3974B5B8FFDD3AFB1A751EF4AF0534572FE67EE463ED3CB7C8FDF3EF7FFD4BDB50EF23C2E15529E643850B647BE909579F05831B51D38699E6418CA74A5EF73672CFC72FA514C463CF72F2383C9534EA79622280FD705C3F9655ABA7B948A4D9804F89CB740E4421543E377EB94BCE18984E10AB462A5BB3A2EC7E96B8077538CBA1BF769C92E0B76EA065D396A753003C1101DE95BC808858FAAE8E1BA4CAB26DF8BF4D23B3C7604D29F181C6983D1EA12C3D788EB821A563B88E069689FFEF68C72B24D77F4896D74E2C60A927CAF5290C5A88D2D17FCF7AA5D5A79577D149EEAEFA9CA6D425E0666B368B0009EEA254B1A8B883A62B72F78C6E0CED2450B0736C874561736F696F396F3CE45CDC0A0B15191A94A7C59A00A1EDD524285EF7F1CCF11C5935A7FC22B8FC9EA73B20DC4866057DDB9187E09711883DDAB9E6050ACA9A117CFF668616C07AABC82290024FBC44DC33D2F88DB6C6AEC61CF7253C38C12188B51E0AD7ADB5788148491917AD339852E015FD1C25CA33FAAF3476B238B4577AB2FFE516C5A0D3810C044ABF780690290C704455A74A4475046157E5F1683012F3615359F6AE78C905B57965A969A27AB99902070A918CC84D9AD2A4A1A9A1B7559BB9AD5F1B58399881ECC9ADD5D27D2C90788A4D7E5164D0A55A7EA8ABB4B093F4BAC528A92DA24E6DEACB64B2311034D373818A50B59BF81B2C816945013793D37356C3F4591FF7DACA4BDCC4B908DAA9E882E29DE564DDFD372F0EB07E26A1B67A6F4F02CE42B13EDF539333DB3F607E07FFADDDEBF21AF2BDD54407380BDE45130C297AE75A0B1898D5C35F9561722CF7B97EB4475E8BE0F295254AFD4F27A78B30C90B3C55FCCC2CB96B9A8CC396AC3F713F7CC442241068DB176048B7737E328862DD9D173774BBF7EDC716AA31CF64DA977D091041931868E0806D27EC4E2EC2C409CA21902A5AE376E529F63C4D58C567D1969A2DC0742EDF398ED9C81E2EFDA62000EADCFA4E05859D8B189CD35EB998AF9442BCE2BB04B5131A211703AE0F5733D934CC5F9840E1F21E64A3D8BFD8D392C9AEC6DE8D01C00573A8C1995045029167AE593A31C5BD44C03BEA3319CC285BE1B80E53165E9EE1399FEDFAEAC5EA11671178986393C7EDA769070716467DAD5553B9E54F3D1726F8980EE02A02D68A9379C5083F85599EB3069CACAD2F310843FF120892B7FFC029F285795238C4C59503C9B8D2D7EB952E2572C6B4FCA07007F4790975F3FDF3EBDB670C248454AF3DC3EBABE4E8D51F3F967CD999A1E5EEA8649DFF8F84878C21A3D48B1264FA8B2C184CD9E968771927D3007C050882132040205FF78B291CE372E830B5C6E33902FA8E8EFB7ABED8D698BBFFB9F394736D62C7B294A5D3C9B0ACE7C7669F34164D669112F75D33B74C01B87B62F9B9C1ABF53C1D0B5F6E1F38ECA2FC07845386235CFECF2EBA04F07FB79F044ADEAAB44C90889F02B29F940C58DE0AC4818B61051E92E5DA4238C8FFDEB0657CDB0EA2F6642E07147BA35A801D02CAB18D0F501634CBA73D56369CE8984B3380A14F000FC5B30BD022253506B4D70D5F54F2F774C7A4FFD7ED7BFCEBA96AD88F05FE69335E696044E0DF82B4F5A0D3A8269469115AB3777C2703088A0569AC027E48EC38ADFB15FD13F5DE428A3794616E2A5FD87C3A68FFEDAF506A36BF758743617117B25030727157556D23F4ED667F5546CA16A049752495AEA55EC8D2AFD4070831452C63E4A74FF31D11905B7F88F00E74FA89CA3E10C66665BA56F112897BDF56EA3C173C889CC4E0DFF17F46EB2CE12DABF86C9E40FD58033C872F2E9F162446017FC36752DF7A813F57BCD246E1EF223071D960FFFB932BFD718CDE84C3CB078489CD1850E43506A537FA22AEE1D51A714F17ECF490DDBBB86A8C1D5FB6D06375D97CB55BC80C51419802738A4540F360394737D73FB840B2128CAD5E7724F8C2FD8FAF4DAEEDEE49315BD4C43658E8B4B7E7B35A5CD33A3ABDF8CE649AB6D634B11915EB3A69BB1AA492CFE26520D8AD0EF858E7E0E22BB68B9A84C6C693983072CDC8E25CEB2B6829DFBF15E16534CCB02A191855A75D940B3E64EDBC2C04F1A461FE41C58539D0B6C3866B385DF001649A81CB6CD48B59283FD4DA00C51BACF5FB934E4913C4E36B835AD322DB07190A73385FE2349D532989F65FB814D6BE8DD110CE38B6DDB2243EC538BE75922CC3C424D880D0F9D14F2195DC7684AD3197A1A15A9B11E530C3D20D9D69172DAF658982F1450944587FFAF5A58246ECB103CAF23E0100131C52E8B7C97E1F27C4F54D50DF98154A7C9AEC40EAB954D859EB199A96083AB4378101F70136DADC5D6FBF1985AAE6FE6D75D8E13BD9D4B5A07BC0A4F25CB6E1BDD86D83FD55B530E180CB1DDFDDEDA99F2E16D3FC23B66B8EEEA0C21EB33EF974C13E4F62EA6C17B855B05001BB5F0EACB75B97129F37BCBA6A598DABF559E0B7EE4A4F5046BCA28D5308827F0A4DE364C9895FFB06A2C1299F5BFAA58168AFA7CB6E4742694F8D87B59DCB41826D98D50215ADD2C0FC90995B82E74EDEF7CC2F1F87D302AE63C0C4E262912125DC0FA4A629D3779030EB16ABF44FB0466EE1168DB37DEBEBCB1998A175BDF10FA6395BE975AF6C214C63642F09D5BE46FD10B02243C10F312398C664D3C4F8F2EE6BFC8BA7F22B6381DB3B26DFB3259B9976D22065A0B109BC0AE8E7EA399A04C7758625F80F4D91C939B5C445E253814CEC0B482C40D755A02F8BDF2E97A2B89854136B36476A5D25DE4B18CF010491E10C675BF563FCC205ABA00DCF7DDE260333C659A810E002D0D6D99EFF4C6107163BB623F1E7BF2C15599CA66E8EC3DA566B8DEEC606B4FE608C97F65D51F58F9158638075B27CFFC4D25A7A318B93D2B14D36633979BF5A4CFD76D0E348D951D9A33865DABC06E5E7CACBD70EC09E10F8D49C7D5FD796F9472B11536D6FB7A5DEBD33BD54E76BF517D3F1BF1049BEFFF8957E4901F99645FD1A1E7FCE5D199999B08BDED1C99D47DA788416F07A177DE00D6B39A8CA10EE2FD18FAA487FAF1DB9385E750CCC53648645B449F12E010064B2FE4B1AAAD15757A27011065CC8059295E771672D8E48E98FC968C62642B2AF47D47EFFCED222207ED2ED158E16D6261194DF906C43C7458DA150DC6B077C49BB647B5CF89405BF860C9088BE7C31737592662F70CB908306DC5D34CD5C50F5CD51E442F5EA1059CC704995CFA22E901D155ACB5B1FFE446C46C4DE413E7C646112D0106F8FDC9BEB2A009EF27507ED52147A6D8F93756EEA3A63147969AFE76917798C0B9EECA6B5B510284145D3522A9C39562FE9E24EB27AD2F0419E9C92A3C4870E8F343902530BAEE50F6A601E53CC6629C45C46AC5051F0C900D226BE7CB89888ACFDDD6B92C0F8B344092B1D1E3B714EC2DE0DDC303BB5E2C68D176C5A27E742517E251F796448054BDC0D606958E46AE5FD77B639AC66DDDA34542001EEBDBA7D0B21ADB4DEFA55758963BC151EE5E59827937140E99D86D7577D6C7ADE78B8961E90CED80B91BF969371719BE918C2C51C3C1C3791EFEE95C89B1155E153F84606946D121E5C73C81680C13FBB30E2351E31446B667B799B1BEBDCDEA1B27FC5CBE5CB339E47F173A63E8307D34A08250FBBB1CAABE2651CD9C58FD5E00FE6D154DD7ECB796311C48911A6D9F3688AF7C630CB214A7566ED7BBC94FE48E23DBFBADB9639F90DED70EF3719AAC18F20B0257B155A6734F0176D35EA9AFF3B3833AEEF7E0B0C9472F6D10AA7DA2CC5CA10F532A045BE5FA1B3734A68E4C62888B795CDDE1FF2E90791A1391D04B0C6D45498A0B69CA7973AFF0AB3B8355F71691FD9698D7DD35D87F4655F65AC9D90CB77C1CB365F3C0414E9E18E7EF55752B3DFF6998DDBF9AD0B47D5496B7C59CA12E598E91100844A7D98BE8015EC8279999517660326ECD6B8BCE7E31CE8EFCAD53286530D0134AE529EBA1C339DF2EBAB1A24F3E7D587FFBA67E36D58369A90AA65FC448756611EAE34EE10564A7E1D438D29D6AADA7BE065B438B1E84AFC3BE4D56F7315DE6586F6205265482424409DE80B147E04951B03E3020111F58ECEE6B76C47A7B80145173F5AFDED84BD4571A104C1534001EBEBA35F8EA987A63BF7AC1437B8E5A69785ECD49E246FB5FCC6BB029D3F84D329ED547596B56414B30A53892F8EF83FE439801A0658F4EB96BA6AEEBAC8E396D9B1235E2F0181765AE70B5316F96DE97F01EE40A1A14376FEAFFAE2FB61ADACC780DD712E9324419F1A1D2307A4B7B106EA3FB5FBB7632EB7316D111E5977489DB2DDE8C1530A1C79042B2D6F9F9C82EC80E2A19438F4190EFD82E8048CB101FED36841CA23AF235AEBC2AF78ED8B699930AD1CD2080055B029B7D29D2ABF44EAA5298CAFB16F9EDA535BEC8D1FA4742341193D61251EF35A61AB7B373D47FB023319C796DA1FA0680523A861E4DE2832F78082BCF23502815203A235FEDBAC636447D609A2A74A78B3E906E944D5B8B2C9EC4149305F34079A5D42387CFD4E648B6C6000FBE26506F3A6CA9C01B87DCCF7C4B2EED6712F3ADEBCEFCE43DC994EF01EFB83FB6BD468C0CB1EF63D67A22DE88C0F7D4D8CCB39B0DAEFE4C7BDC317B71873646E4724794C9792142946B8E38D87CC59C38056836D85BABBC2BD4A12D686C6112590FF41B61271795DF7817C5D58C14ACC345605470897683F5DBC0697B4ED8756A322AEB13365F55CFDB167CA58126C84703CD31B843";

void hexStringToByteArray(const char *hexString, uint8_t *byteArray, size_t length) {
    for (size_t i = 0; i < length; i++) {
        sscanf(hexString + 2 * i, "%2hhx", &byteArray[i]);
    }
}

// Custom task for key pair generation
TaskHandle_t keygen_decapsulationTaskHandle;

void keygen_decapsulationTask(void *pvParameters) {
    Serial.println("\nStarting Keygen with decapsulation task...");

    // Allocate memory for pk and sk on the heap
    unsigned char *sk = (unsigned char *)heap_caps_malloc(SECRET_KEY_BYTES, MALLOC_CAP_8BIT);
    unsigned char *ct = (unsigned char *)heap_caps_malloc(CIPHERTEXT_BYTES, MALLOC_CAP_8BIT);
    unsigned char *key2 = (unsigned char *)heap_caps_malloc(SHARED_SECRET_BYTES, MALLOC_CAP_8BIT);


    // Check allocation
    if (!sk) {
        Serial.println("Memory allocation failed for pk or sk!");
        heap_caps_free(sk);
        vTaskDelete(NULL);
    }

    hexStringToByteArray(sk_static, sk, SECRET_KEY_BYTES);
    hexStringToByteArray(cipher_text_string, ct, CIPHERTEXT_BYTES);

    clock_gettime(CLOCK_MONOTONIC, &start);
    crypto_kem_dec(key2, ct, sk);
    clock_gettime(CLOCK_MONOTONIC, &end);
    double time_ms = (end.tv_sec - start.tv_sec) * 1000.0 + (end.tv_nsec - start.tv_nsec) / 1000000.0;
    Serial.printf("Priemerný čas [decapsulation]: %.3f ms\n",time_ms);
    time_ms = 0.0;


    Serial.println("\n ************************************************************************* ");
    
    Serial.println("\nsecret2 (ss): ");
    for (int i = 0; i < SHARED_SECRET_BYTES; ++i) Serial.printf("%02X", key2[i]);
    
    // Cleanup
    heap_caps_free(sk);
    heap_caps_free(ct);
    heap_caps_free(key2);

    vTaskDelete(NULL); // End the task
}

void setup() {
    Serial.begin(9600);
    delay(5000); 

    xTaskCreatePinnedToCore(keygen_decapsulationTask, "keygen_decapsulationTask", 65536, NULL, 1, &keygen_decapsulationTaskHandle, 1);
}

void loop() {}
